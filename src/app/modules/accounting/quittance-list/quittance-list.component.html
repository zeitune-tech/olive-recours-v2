<div class="w-full mb-20" *transloco="let t">

  <div class="flex flex-col mb-6">
    <h1 class="text-2xl md:text-4xl font-bold py-4">
      {{ t('entities.accounting.quittanceList.title') }}
    </h1>    
    <p class="text-sm md:text-base text-gray-600">
      {{ t('entities.accounting.quittanceList.description') }}
    </p>
  </div>

  <div class="bg-white p-6 rounded-lg shadow border border-gray-100">
    
    <!-- Company Selection for MLA -->
    <div *ngIf="isMLA()" class="mb-6">
      <h3 class="text-lg font-semibold mb-3">{{ t('entities.accounting.selectCompany') }}</h3>
      <div class="flex flex-wrap justify-start items-center gap-4 mb-4">
        <div *ngFor="let company of companies"
            (click)="selectCompany(company)"
            class="flex flex-col items-center bg-white border border-gray-200 rounded-lg p-3 cursor-pointer hover:shadow transition min-w-40 max-w-40"
            [class.ring-2]="selectedCompany?.id === company.id"
            [class.ring-primary-600]="selectedCompany?.id === company.id">
            <img [src]="company.logo" alt="{{ company.acronym }}" class="w-auto h-10 object-cover rounded-md mb-2" />
            <p class="text-center text-xs font-medium">{{ company.name }}</p>
        </div>
      </div>
      <div *ngIf="!selectedCompany" class="text-orange-600 text-sm mb-4">
        <mat-icon class="align-middle mr-1">info</mat-icon>
        {{ t('entities.accounting.pleaseSelectCompany') }}
      </div>
    </div>

    <!-- Filters Section -->
    <div class="flex flex-col md:flex-row gap-4 mb-6">
      <!-- Search -->
      <mat-form-field appearance="outline" class="flex-1">
        <mat-label>{{ t('entities.accounting.quittanceList.searchQuittance') }}</mat-label>
        <input matInput [(ngModel)]="searchTerm" (ngModelChange)="onSearchChange()" 
               placeholder="{{ t('entities.accounting.quittanceList.searchPlaceholder') }}">
        <mat-icon matPrefix>search</mat-icon>
      </mat-form-field>

      <!-- Status Filter -->
      <mat-form-field appearance="outline" class="w-48">
        <mat-label>{{ t('entities.accounting.quittanceList.statusFilter') }}</mat-label>
        <mat-select [(value)]="statusFilter" (selectionChange)="onStatusFilterChange()">
          <mat-option value="ALL">{{ t('entities.accounting.quittanceList.allStatus') }}</mat-option>
          <mat-option value="NON_ENCAISSE">{{ t('entities.accounting.quittanceList.nonEncaisse') }}</mat-option>
          <mat-option value="PARTIEL">{{ t('entities.accounting.quittanceList.partiel') }}</mat-option>
          <mat-option value="ENCAISSE">{{ t('entities.accounting.quittanceList.encaisse') }}</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Refresh Button -->
      <button mat-raised-button color="primary" (click)="loadQuittances()" [disabled]="isLoading">
        <mat-icon>refresh</mat-icon>
        {{ t('buttons.refresh') }}
      </button>
    </div>

    <!-- Loading Indicator -->
    <div *ngIf="isLoading" class="flex justify-center py-8">
      <mat-spinner diameter="50"></mat-spinner>
    </div>

    <!-- Quittances Table -->
    <div *ngIf="!isLoading && filteredQuittances.length > 0" class="overflow-x-auto">
      <table class="min-w-full border text-sm">
        <thead class="bg-gray-50">
          <tr>
            <th class="border px-4 py-3 text-left font-semibold">{{ t('entities.accounting.quittanceList.quittanceNumber') }}</th>
            <th class="border px-4 py-3 text-right font-semibold">{{ t('entities.accounting.quittanceList.quittanceAmount') }}</th>
            <th class="border px-4 py-3 text-left font-semibold">{{ t('entities.accounting.quittanceList.issueDate') }}</th>
            <th class="border px-4 py-3 text-center font-semibold">{{ t('entities.accounting.quittanceList.encaissementCount') }}</th>
            <th class="border px-4 py-3 text-right font-semibold">{{ t('entities.accounting.quittanceList.totalEncashed') }}</th>
            <th class="border px-4 py-3 text-right font-semibold">{{ t('entities.accounting.quittanceList.balance') }}</th>
            <th class="border px-4 py-3 text-center font-semibold">{{ t('entities.accounting.quittanceList.status') }}</th>
            <th class="border px-4 py-3 text-center font-semibold">{{ t('entities.accounting.quittanceList.actions') }}</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let quittance of filteredQuittances" class="hover:bg-gray-50">
            <!-- Quittance Number -->
            <td class="border px-4 py-3 font-medium">
              {{ quittance.numero }}
              <div class="text-xs text-gray-500">{{ quittance.nature }}</div>
            </td>

            <!-- Quittance Amount -->
            <td class="border px-4 py-3 text-right font-semibold">
              {{ quittance.montant | number:'1.0-0' }} FCFA
            </td>

            <!-- Issue Date -->
            <td class="border px-4 py-3">
              {{ quittance.dateSortQuittance | date:'dd/MM/yyyy' }}
            </td>

            <!-- Encaissement Count -->
            <td class="border px-4 py-3 text-center">
              <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                {{ quittance.nombreEncaissements }}
              </span>
            </td>

            <!-- Total Encashed -->
            <td class="border px-4 py-3 text-right font-semibold text-green-600">
              {{ quittance.montantEncaisse | number:'1.0-0' }} FCFA
            </td>

            <!-- Balance -->
            <td class="border px-4 py-3 text-right font-semibold"
                [class.text-green-600]="quittance.soldeQuittance === 0"
                [class.text-orange-600]="quittance.soldeQuittance > 0 && quittance.montantEncaisse > 0"
                [class.text-red-600]="quittance.soldeQuittance === quittance.montant">
              {{ quittance.soldeQuittance | number:'1.0-0' }} FCFA
            </td>

            <!-- Status -->
            <td class="border px-4 py-3 text-center">
              <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                    [ngClass]="getStatusBadgeClass(quittance.statutEncaissement)">
                {{ getStatusLabel(quittance.statutEncaissement) }}
              </span>
            </td>

            <!-- Actions -->
            <td class="border px-4 py-3 text-center">
              <div class="flex justify-center gap-2">
                <!-- View Encaissements -->
                <button mat-icon-button 
                        *ngIf="quittance.nombreEncaissements > 0"
                        (click)="viewEncaissements(quittance)"
                        matTooltip="{{ t('entities.accounting.quittanceList.viewEncaissements') }}"
                        color="primary">
                  <mat-icon>visibility</mat-icon>
                </button>

                <!-- Add Encaissement -->
                <button mat-icon-button
                        *ngIf="quittance.soldeQuittance > 0"
                        (click)="addEncaissement(quittance)"
                        matTooltip="{{ t('entities.accounting.quittanceList.addEncaissement') }}"
                        color="accent">
                  <mat-icon>add_circle</mat-icon>
                </button>

                <!-- Edit Encaissement (only for single encaissement) -->
                <button mat-icon-button
                        *ngIf="quittance.nombreEncaissements === 1"
                        (click)="editEncaissement(quittance)"
                        matTooltip="{{ t('entities.accounting.quittanceList.editEncaissement') }}"
                        color="primary">
                  <mat-icon>edit</mat-icon>
                </button>

                <!-- Delete Encaissement (only for single encaissement) -->
                <button mat-icon-button
                        *ngIf="quittance.nombreEncaissements === 1"
                        (click)="deleteEncaissement(quittance, quittance.encaissements[0])"
                        matTooltip="{{ t('entities.accounting.quittanceList.deleteEncaissement') }}"
                        color="warn">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Summary Row -->
      <div class="bg-gray-100 p-4 rounded-b-lg border-t-2 border-gray-300">
        <div class="flex justify-between items-center text-sm font-semibold">
          <span>{{ t('entities.accounting.total') }}: {{ filteredQuittances.length }} {{ t('entities.accounting.quittanceList.quittances') }}</span>
          <div class="flex gap-6">
            <span>{{ t('entities.accounting.quittanceList.totalQuittanceAmount') }}: 
              <span class="text-blue-600">{{ getTotalQuittanceAmount() | number:'1.0-0' }} FCFA</span>
            </span>
            <span>{{ t('entities.accounting.quittanceList.totalEncashedAmount') }}: 
              <span class="text-green-600">{{ getTotalEncashedAmount() | number:'1.0-0' }} FCFA</span>
            </span>
            <span>{{ t('entities.accounting.quittanceList.totalBalance') }}: 
              <span class="text-orange-600">{{ getTotalBalance() | number:'1.0-0' }} FCFA</span>
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- No Data Message -->
    <div *ngIf="!isLoading && filteredQuittances.length === 0 && !hasError" class="text-center py-12">
      <mat-icon class="text-gray-400 text-6xl mb-4">receipt_long</mat-icon>
      <h3 class="text-lg font-medium text-gray-900 mb-2">{{ t('entities.accounting.quittanceList.noQuittances') }}</h3>
      <p class="text-gray-500">{{ t('entities.accounting.quittanceList.noQuittancesDescription') }}</p>
    </div>

    <!-- Error Message -->
    <div *ngIf="hasError && !isLoading" class="text-center py-12">
      <mat-icon class="text-red-400 text-6xl mb-4">error</mat-icon>
      <h3 class="text-lg font-medium text-red-900 mb-2">{{ t('entities.accounting.quittanceList.errorLoading') }}</h3>
      <p class="text-red-600 mb-4">{{ t('entities.accounting.quittanceList.errorDescription') }}</p>
      <button mat-raised-button color="primary" (click)="loadQuittances()">
        <mat-icon>refresh</mat-icon>
        {{ t('buttons.retry') }}
      </button>
    </div>
  </div>

</div>
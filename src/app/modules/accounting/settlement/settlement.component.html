<div class="w-full mb-20" *transloco="let t">

  <div class="flex flex-col mb-6">
    <h1 class="text-2xl md:text-4xl font-bold py-4">
      {{ t('entities.accounting.settlement.title') }}
    </h1>    
    <p class="text-sm md:text-base text-gray-600">
      {{ t('entities.accounting.settlement.description') }}
    </p>
  </div>

  <div class="bg-white p-6 rounded-lg shadow border border-gray-100">
    <h2 class="text-xl font-bold mb-4">{{ t('entities.accounting.settlement.statementsTitle') }}</h2>

    <!-- Company Selection for MLA -->
    <div *ngIf="isMLA()" class="mb-6">
      <h3 class="text-lg font-semibold mb-3">{{ t('entities.accounting.selectCompany') }}</h3>
      <div class="flex flex-wrap justify-start items-center gap-4 mb-4">
        <div *ngFor="let company of companies"
            (click)="selectCompany(company)"
            class="flex flex-col items-center bg-white border border-gray-200 rounded-lg p-3 cursor-pointer hover:shadow transition min-w-40 max-w-40"
            [class.ring-2]="selectedCompany?.id === company.id"
            [class.ring-primary-600]="selectedCompany?.id === company.id">
            <img [src]="company.logo" alt="{{ company.acronym }}" class="w-auto h-10 object-cover rounded-md mb-2" />
            <p class="text-center text-xs font-medium">{{ company.name }}</p>
        </div>
      </div>
      <div *ngIf="!selectedCompany" class="text-orange-600 text-sm mb-4">
        <mat-icon class="align-middle mr-1">info</mat-icon>
        {{ t('entities.accounting.pleaseSelectCompany') }}
      </div>
    </div>

    <!-- View Mode Toggle -->
    <div class="flex items-center gap-4 mb-6">
      <mat-button-toggle-group [(value)]="isMonthlyView" (change)="onViewModeChange()">
        <mat-button-toggle [value]="true">{{ t('entities.accounting.monthlyView') }}</mat-button-toggle>
        <mat-button-toggle [value]="false">{{ t('entities.accounting.periodView') }}</mat-button-toggle>
      </mat-button-toggle-group>
    </div>

    <!-- Monthly View Selectors -->
    <div *ngIf="isMonthlyView" class="flex items-center gap-4 mb-6">
      <div class="flex-1 flex gap-6">
        <mat-form-field appearance="outline" class="w-40">
          <mat-label>{{ t('entities.accounting.month') }}</mat-label>
          <mat-select [(value)]="selectedMonth" (selectionChange)="onMonthYearChange()">
            <mat-option *ngFor="let m of months" [value]="m.value">{{ m.label }}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="w-32">
          <mat-label>{{ t('entities.accounting.year') }}</mat-label>
          <input matInput type="number" [(ngModel)]="selectedYear" (change)="onMonthYearChange()">
        </mat-form-field>
      </div>
    </div>

    <!-- Period View Selectors -->
    <div *ngIf="!isMonthlyView" class="flex items-center gap-4 mb-6">
      <div class="flex-1 flex gap-6">
        <mat-form-field appearance="outline" class="w-48">
          <mat-label>{{ t('entities.accounting.startDate') }}</mat-label>
          <input matInput [matDatepicker]="startPicker" [(ngModel)]="startDate" (dateChange)="onDateRangeChange()">
          <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
          <mat-datepicker #startPicker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline" class="w-48">
          <mat-label>{{ t('entities.accounting.endDate') }}</mat-label>
          <input matInput [matDatepicker]="endPicker" [(ngModel)]="endDate" (dateChange)="onDateRangeChange()">
          <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
          <mat-datepicker #endPicker></mat-datepicker>
        </mat-form-field>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex items-center gap-4 mb-6">
      <button mat-raised-button color="primary" (click)="loadReglementStatement()" [disabled]="isLoading">
        <mat-icon>refresh</mat-icon>
        {{ t('buttons.loadStatement') }}
      </button>
      <button mat-raised-button color="primary" (click)="downloadPdf()" [disabled]="isLoading || !reglementStatement">
        <mat-icon>download</mat-icon>
        {{ t('buttons.downloadPdf') }}
      </button>
    </div>

    <!-- Loading Indicator -->
    <div *ngIf="isLoading" class="flex justify-center py-8">
      <mat-spinner diameter="50"></mat-spinner>
    </div>

    <!-- Statement Table -->
    <div *ngIf="reglementStatement && !isLoading" class="mt-6">
      <h3 class="text-lg font-semibold mb-3">
        {{ t('entities.accounting.settlement.statementFor') }}: {{ getDisplayEntityName() }}
      </h3>
      
      <!-- Summary Info -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-blue-50 p-4 rounded-lg">
          <h4 class="text-sm font-medium text-blue-800">{{ t('entities.accounting.settlement.totalQuittances') }}</h4>
          <p class="text-2xl font-bold text-blue-900">{{ reglementStatement.nombreQuittances }}</p>
        </div>
        <div class="bg-red-50 p-4 rounded-lg">
          <h4 class="text-sm font-medium text-red-800">{{ t('entities.accounting.settlement.totalAmount') }}</h4>
          <p class="text-2xl font-bold text-red-900">{{ reglementStatement.totalMontantQuittances | number:'1.0-0' }} FCFA</p>
        </div>
        <div class="bg-purple-50 p-4 rounded-lg">
          <h4 class="text-sm font-medium text-purple-800">{{ t('entities.accounting.period') }}</h4>
          <p class="text-lg font-semibold text-purple-900">{{ reglementStatement.period }}</p>
        </div>
        <div class="bg-orange-50 p-4 rounded-lg">
          <h4 class="text-sm font-medium text-orange-800">{{ t('entities.accounting.generatedBy') }}</h4>
          <p class="text-lg font-semibold text-orange-900">{{ reglementStatement.generatedBy }}</p>
        </div>
      </div>

      <!-- Quittance Lines Table -->
      <div class="overflow-x-auto">
        <table class="min-w-full border text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="border px-4 py-2 text-left">{{ t('entities.accounting.settlement.quittanceNumber') }}</th>
              <th class="border px-4 py-2 text-right">{{ t('entities.accounting.settlement.quittanceAmount') }}</th>
              <th class="border px-4 py-2 text-left">{{ t('entities.accounting.settlement.issueDate') }}</th>
              <th class="border px-4 py-2 text-left">{{ t('entities.accounting.settlement.claimNumber') }}</th>
              <th class="border px-4 py-2 text-left">{{ t('entities.accounting.settlement.claimReference') }}</th>
              <th class="border px-4 py-2 text-right">{{ t('entities.accounting.settlement.settlementCount') }}</th>
              <th class="border px-4 py-2 text-right">{{ t('entities.accounting.settlement.totalSettled') }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let line of reglementStatement.quittanceLines" class="hover:bg-gray-50">
              <td class="border px-4 py-2 font-medium">{{ line.quittanceNumero }}</td>
              <td class="border px-4 py-2 text-right">{{ line.montantQuittance | number:'1.0-0' }}</td>
              <td class="border px-4 py-2">{{ line.dateSortQuittance | date:'dd/MM/yyyy' }}</td>
              <td class="border px-4 py-2">{{ line.claimNumero || '-' }}</td>
              <td class="border px-4 py-2">{{ line.claimReference || '-' }}</td>
              <td class="border px-4 py-2 text-right">{{ line.nombreEncaissements }}</td>
              <td class="border px-4 py-2 text-right">{{ line.totalMontantEncaisse | number:'1.0-0' }}</td>
            </tr>
          </tbody>
          <tfoot class="bg-gray-100 font-semibold">
            <tr>
              <td class="border px-4 py-2">{{ t('entities.accounting.total') }}</td>
              <td class="border px-4 py-2 text-right">{{ reglementStatement.totalMontantQuittances | number:'1.0-0' }}</td>
              <td class="border px-4 py-2" colspan="4"></td>
              <td class="border px-4 py-2 text-right">
                {{ getTotalSettled() | number:'1.0-0' }}
              </td>
            </tr>
          </tfoot>
        </table>
      </div>

      <!-- Generation Info -->
      <div class="mt-4 text-sm text-gray-600 text-center">
        {{ t('entities.accounting.generatedOn') }}: {{ reglementStatement.generationDate | date:'dd/MM/yyyy HH:mm' }}
      </div>
    </div>

    <!-- No Data Message -->
    <div *ngIf="!reglementStatement && !isLoading && !hasError" class="text-center py-8">
      <mat-icon class="text-gray-400 text-6xl mb-4">receipt</mat-icon>
      <p class="text-gray-500">{{ t('entities.accounting.settlement.noData') }}</p>
    </div>

    <!-- Error Message -->
    <div *ngIf="hasError && !isLoading" class="text-center py-8">
      <mat-icon class="text-red-400 text-6xl mb-4">error</mat-icon>
      <p class="text-red-500">{{ t('entities.accounting.settlement.errorLoading') }}</p>
      <button mat-raised-button color="primary" (click)="loadReglementStatement()" class="mt-4">
        <mat-icon>refresh</mat-icon>
        {{ t('buttons.retry') }}
      </button>
    </div>
  </div>

</div>